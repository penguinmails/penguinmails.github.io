name: Documentation Validation

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'

jobs:
  # Critical checks that fail the build
  critical-link-checks:
    name: Critical Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .md extensions in /docs/ links
        id: check-md-extensions
        run: |
          echo "## Link Extension Check" >> $GITHUB_STEP_SUMMARY
          violations=$(find docs -name "*.md" -type f -exec grep -H -n '](/docs/.*\.md[)#]' {} \; 2>/dev/null || true)
          if [ -n "$violations" ]; then
            count=$(echo "$violations" | wc -l)
            echo "::error::Found $count links with .md extensions in docs/ folder"
            # Output first 20 violations using process substitution to avoid subshell
            while IFS=: read -r file line content; do
              echo "::error file=$file,line=$line::$file:$line - Remove .md extension from link"
            done < <(echo "$violations" | head -20)
            if [ $count -gt 20 ]; then
              echo "::error::... and $((count - 20)) more violations (see job summary for full list)"
            fi
            echo "âŒ **FAILED**: Found $count links with .md extensions" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$violations" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **PASSED**: No .md extensions in /docs/ links" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for relative .md links (./  or ../)
        id: check-relative-links
        run: |
          echo "## Relative Link Check" >> $GITHUB_STEP_SUMMARY
          violations=$(find docs -name "*.md" -type f -exec grep -H -n -E ']\((\.\/|\.\.\/)' {} \; 2>/dev/null || true)
          if [ -n "$violations" ]; then
            count=$(echo "$violations" | wc -l)
            echo "::error::Found $count relative links using ./ or ../ in docs/ folder"
            # Output first 20 violations using process substitution
            while IFS=: read -r file line content; do
              echo "::error file=$file,line=$line::$file:$line - Use site-absolute links starting with /docs/"
            done < <(echo "$violations" | head -20)
            if [ $count -gt 20 ]; then
              echo "::error::... and $((count - 20)) more violations (see job summary for full list)"
            fi
            echo "âŒ **FAILED**: Found $count relative links" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$violations" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **PASSED**: No relative links in docs/" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for relative CONTRIBUTING.md links
        id: check-contributing-links
        run: |
          echo "## CONTRIBUTING.md Link Check" >> $GITHUB_STEP_SUMMARY
          violations=$(find docs -name "*.md" -type f -exec grep -H -n 'CONTRIBUTING\.md' {} \; 2>/dev/null | grep -v 'github.com' || true)
          if [ -n "$violations" ]; then
            count=$(echo "$violations" | wc -l)
            echo "::error::Found $count relative links to CONTRIBUTING.md in docs/ folder"
            # Output all violations using process substitution
            while IFS=: read -r file line content; do
              echo "::error file=$file,line=$line::$file:$line - Use GitHub link instead of relative link"
            done < <(echo "$violations")
            echo "âŒ **FAILED**: Found $count relative CONTRIBUTING.md links" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$violations" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip**: Use GitHub links like \`https://github.com/USER/REPO/blob/main/CONTRIBUTING.md\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **PASSED**: No relative CONTRIBUTING.md links" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for relative README.md links
        id: check-readme-links
        run: |
          echo "## README.md Link Check" >> $GITHUB_STEP_SUMMARY
          violations=$(find docs -name "*.md" -type f -exec grep -H -n -E ']\([./]*README\.md[)#]' {} \; 2>/dev/null | grep -v 'github.com' || true)
          if [ -n "$violations" ]; then
            count=$(echo "$violations" | wc -l)
            echo "::error::Found $count relative links to root README.md in docs/ folder"
            # Output all violations using process substitution
            while IFS=: read -r file line content; do
              echo "::error file=$file,line=$line::$file:$line - Use GitHub link instead of relative link"
            done < <(echo "$violations")
            echo "âŒ **FAILED**: Found $count relative README.md links" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$violations" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip**: Use GitHub links like \`https://github.com/USER/REPO/blob/main/README.md\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **PASSED**: No relative README.md links" >> $GITHUB_STEP_SUMMARY
          fi

  # Warning checks that don't block the build
  warning-checks:
    name: Documentation Warnings
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for links to tasks/ folder
        id: check-tasks-links
        run: |
          echo "## Tasks Folder Link Check (Warning)" >> $GITHUB_STEP_SUMMARY
          violations=$(find docs -name "*.md" -type f -exec grep -H -n '](.*tasks/' {} \; 2>/dev/null || true)
          if [ -n "$violations" ]; then
            echo "::warning::Found links to tasks/ folder (will be moved inside docs in future)"
            count=$(echo "$violations" | wc -l)
            echo "âš ï¸ **WARNING**: Found $count links to tasks/ folder" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "These links will need to be updated when tasks/ is moved inside docs/" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No links to tasks/ folder" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for links to user-journeys/ folder
        id: check-journeys-links
        run: |
          echo "## User Journeys Link Check (Warning)" >> $GITHUB_STEP_SUMMARY
          violations=$(find docs -name "*.md" -type f -exec grep -H -n '](.*user-journeys/' {} \; 2>/dev/null || true)
          if [ -n "$violations" ]; then
            echo "::warning::Found links to user-journeys/ folder (will be moved inside docs in future)"
            count=$(echo "$violations" | wc -l)
            echo "âš ï¸ **WARNING**: Found $count links to user-journeys/ folder" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "These links will need to be updated when user-journeys/ is moved inside docs/" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No links to user-journeys/ folder" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for missing frontmatter fields
        id: check-frontmatter
        run: |
          echo "## Frontmatter Check (Warning)" >> $GITHUB_STEP_SUMMARY
          
          missing_title=$(find docs -name "*.md" -type f -exec grep -L "^title:" {} \; 2>/dev/null || true)
          missing_description=$(find docs -name "*.md" -type f -exec grep -L "^description:" {} \; 2>/dev/null || true)
          missing_level=$(find docs -name "*.md" -type f -exec grep -L "^level:" {} \; 2>/dev/null || true)
          
          title_count=$(echo "$missing_title" | grep -c . || echo "0")
          desc_count=$(echo "$missing_description" | grep -c . || echo "0")
          level_count=$(echo "$missing_level" | grep -c . || echo "0")
          
          if [ "$title_count" -gt 0 ] || [ "$desc_count" -gt 0 ] || [ "$level_count" -gt 0 ]; then
            echo "::warning::Found files with missing frontmatter fields"
            echo "âš ï¸ **WARNING**: Frontmatter issues found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Missing title: $title_count files" >> $GITHUB_STEP_SUMMARY
            echo "- Missing description: $desc_count files" >> $GITHUB_STEP_SUMMARY
            echo "- Missing level: $level_count files" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All files have complete frontmatter" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for tech stack violations
        id: check-tech-stack
        run: |
          echo "## Tech Stack Check (Warning)" >> $GITHUB_STEP_SUMMARY
          
          python_blocks=$(find docs -name "*.md" -type f -exec grep -H -n '^```python' {} \; 2>/dev/null || true)
          ruby_blocks=$(find docs -name "*.md" -type f -exec grep -H -n '^```ruby' {} \; 2>/dev/null || true)
          php_blocks=$(find docs -name "*.md" -type f -exec grep -H -n '^```php' {} \; 2>/dev/null || true)
          
          python_count=$(echo "$python_blocks" | grep -c : || echo "0")
          ruby_count=$(echo "$ruby_blocks" | grep -c : || echo "0")
          php_count=$(echo "$php_blocks" | grep -c : || echo "0")
          
          if [ "$python_count" -gt 0 ] || [ "$ruby_count" -gt 0 ] || [ "$php_count" -gt 0 ]; then
            echo "::warning::Found forbidden code blocks"
            echo "âš ï¸ **WARNING**: Forbidden code blocks found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Python blocks: $python_count" >> $GITHUB_STEP_SUMMARY
            echo "- Ruby blocks: $ruby_count" >> $GITHUB_STEP_SUMMARY
            echo "- PHP blocks: $php_count" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Use TypeScript or JavaScript instead" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No forbidden code blocks" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Critical checks: See 'Critical Link Validation' job" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Warnings: Review findings above" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For more details, see [validation documentation](https://github.com/${{ github.repository }}/blob/main/VERIFICATION.md)" >> $GITHUB_STEP_SUMMARY
