#!/bin/bash

# Whitespace Issues Detection Script
# Usage: ./detect_whitespace_issues.sh [target_directory]
# Detects trailing whitespace

set -e

TARGET_ROOT="${1:-docs}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_DIR="validation/reports"
REPORT_FILE="$REPORT_DIR/whitespace_issues_${TIMESTAMP}.json"
INSTANCES_DIR="$REPORT_DIR/instances"
TRAILING_FILE="$INSTANCES_DIR/trailing_whitespace_${TIMESTAMP}.txt"

mkdir -p "$REPORT_DIR" "$INSTANCES_DIR"

total_issues=0

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "WHITESPACE VALIDATION"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Target: $TARGET_ROOT"
echo "Report: $REPORT_FILE"
echo ""

# Initialize JSON report
echo "{" > "$REPORT_FILE"
echo "  \"timestamp\": \"$(date -Iseconds)\"," >> "$REPORT_FILE"
echo "  \"target_root\": \"$TARGET_ROOT\"," >> "$REPORT_FILE"
echo "  \"issues\": {" >> "$REPORT_FILE"

# Detect trailing whitespace
# We use grep to find lines ending with space/tab
echo "Checking: Trailing whitespace..."

# grep -r "[[:space:]]$" matches lines ending in space or tab
# We exclude .git and other dirs via find if needed, but grep -r is recursive.
# We only want .md files.
files=$(grep -r "[[:space:]]$" "$TARGET_ROOT" --include="*.md" 2>/dev/null || echo "")
count=$(echo "$files" | grep -c ":" || echo "0")

# Save to intermediary file
if [ $count -gt 0 ]; then
    echo "$files" > "$TRAILING_FILE"
fi

echo "    \"trailing_whitespace\": {" >> "$REPORT_FILE"
echo "      \"description\": \"Lines with trailing whitespace\"," >> "$REPORT_FILE"
echo "      \"count\": $count," >> "$REPORT_FILE"
echo "      \"intermediary_file\": \"$TRAILING_FILE\"," >> "$REPORT_FILE"
echo "      \"files\": [" >> "$REPORT_FILE"

if [ $count -gt 0 ]; then
    first=true
    while IFS=: read -r file line; do
        [ -z "$file" ] && continue
        if [ "$first" = true ]; then
            first=false
        else
            echo "," >> "$REPORT_FILE"
        fi
        # Escape quotes in line content for JSON
        clean_line=$(echo "$line" | sed 's/"/\\"/g')
        echo -n "        {\"file\": \"$file\", \"content\": \"$clean_line\"}" >> "$REPORT_FILE"
        echo -e "  ${RED}✗${NC} $file"
    done <<< "$files"
    echo "" >> "$REPORT_FILE"
    total_issues=$((total_issues + count))
fi

echo "      ]" >> "$REPORT_FILE"
echo "    }" >> "$REPORT_FILE"

# Close JSON report
echo "  }," >> "$REPORT_FILE"
echo "  \"total_issues\": $total_issues" >> "$REPORT_FILE"
echo "}" >> "$REPORT_FILE"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "SUMMARY"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [ $total_issues -eq 0 ]; then
    echo -e "${GREEN}✓${NC} All whitespace checks passed!"
    exit 0
else
    echo -e "${RED}✗${NC} Found $total_issues whitespace violations"
    echo "Report saved to: $REPORT_FILE"
    if [ -f "$TRAILING_FILE" ]; then
        echo "Intermediary file for fixes: $TRAILING_FILE"
    fi
    exit 1
fi
